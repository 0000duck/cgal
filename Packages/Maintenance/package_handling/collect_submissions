#! /net/bin/perl5 -T

use strict;

#--------------------------------------------------------------#
# This script scans through the mail box $::MAILBOX, using procmail.
# If a message contains a line with the format
#
# package: <URL>
#
# this package will be automatically downloaded, and the sender of
# the message will be notified.
#--------------------------------------------------------------#

# the mail boxes

$::LOCKFILE='/projects/CGAL/submissions/autohandle/data/collect_submission.lock';
$::MAIL_IN='/users/geert/PUBLIC/CGAL-submit/incoming-mail';
#$::MAIL_OUT='/users/geert/tmp/handled-mail';
$::MAIL_TMP='/users/geert/PUBLIC/CGAL-submit/temp-mail';
$::SCRIPT='/projects/CGAL/submissions/autohandle/scripts/collect_submissions';
$::MAINTAINER='cgal-submit@cs.uu.nl';

# program locations
$::FORMAIL='/projects/CGAL/submissions/autohandle/scripts/formail';
$::treat_one_mail_program =
'/projects/CGAL/submissions/autohandle/scripts/treat_submit_mail';
$::LOCKCMD='/projects/CGAL/submissions/autohandle/scripts/lockfile';

# the log file
$::LOGFILE='/projects/CGAL/submissions/autohandle/data/collect_submissions.log';

# 
$::seconds_between_invocations=600;
$::max_tries_between_warning= int 21600/$::seconds_between_invocations;

$ENV{PATH}='/sbin:/usr/sbin:/usr/bsd:/bin:/usr/bin';

$::please_die=0;
$::hostname = $ENV{HOST};
if ($::hostname =~ /^\s*([-\@\w]+)\s*$/) {
    $::hostname = $1;
} else {
    open NOTICE, "|Mail -s \"Collect_submissions not started!\" $::MAINTAINER";
    print NOTICE <<"TOTHIER";
The script $::SCRIPT did not start because
the HOST environment value has a strange value.
TOTHIER
    close NOTICE;
    exit 1;
}

sub termination_signal_handler {
    $::please_die=1;
}

$::tries = 1;
$::first_time = 1;
$SIG{INT} = \&termination_signal_handler;
$SIG{TERM} = \&termination_signal_handler;
while (! $::please_die) {
    if ( system("$::LOCKCMD", "-r", '10', "$::LOCKFILE") != 0) {
	--$::tries;
	if ($::tries < 0) {
	    open NOTICE, "|Mail -s \"Collect_submissions locked!\" $::MAINTAINER";
	    print NOTICE <<"TOTHIER";
The script $::SCRIPT could not proceed because
it could not acquire the needed lock on file $::LOCKFILE.
TOTHIER
	    close NOTICE;
	    $::tries = $::max_tries_between_warning;
	}
    } else {
	$::tries = $::max_tries_between_warning;
	if ($::first_time) {
	    my $logline = `tail -1 $::LOGFILE`;
	    if ($logline =~ /started/) {
		unlink $::LOCKFILE;
		open NOTICE, "|Mail -s \"Collect_submissions busy!\" $::MAINTAINER";
		print NOTICE <<"TOTHIER";
The script $::SCRIPT did not proceed because
there seems to be another process collecting the mail messages.
The file $::LOGFILE says:

$logline
TOTHIER
		close NOTICE;
		exit 1;
	    }
	    open LOGFILE, ">>$::LOGFILE";
	    print LOGFILE "$::hostname $$: started executing on ", `date`;
	    close LOGFILE;
	    $::first_time = 0;
	}
    
	if ( -f $::MAIL_TMP ) {
	    open NOTICE, "|Mail -s \"Mail box $::MAIL_TMP was not emptied!\" $::MAINTAINER";
print NOTICE <<"TOTHIER";
	The script $::SCRIPT has been stopped!
TOTHIER
	    close NOTICE;
	    unlink $::LOCKFILE;
	    $::please_die = 1;
	} else {
	    if ( -f $::MAIL_IN ) {
		rename($::MAIL_IN, $::MAIL_TMP);
		if (system("$::FORMAIL -ns $::treat_one_mail_program < $::MAIL_TMP")== 0 )
		{
		    unlink $::MAIL_TMP;
		}
	    }
	}
	unlink $::LOCKFILE;
    }
    sleep $::seconds_between_invocations unless $::please_die;
}

open LOGFILE, ">>$::LOGFILE";
print LOGFILE "$::hostname $$: stopped executing at ", `date`;
close LOGFILE;
exit 1;

